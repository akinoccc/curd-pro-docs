import{c as G,d as E,a as H,u as J,n as L,b as Q,_ as W,e as X,f as Y,g as Z,C as h,h as ee,v as te,i as se,j as re}from"./demo-schema-ee0Otrfg.js";import{f as B,d as $,g as D,h as ae,c as oe,a as r,w as o,u as t,b as l,N as m,i as le,j as N,B as V,t as _,k as M,l as I,o as ie}from"./index-CuDnTDmo.js";import{N as ne,c as de,b as F,a as ue}from"./mock-dicts-Do2PBsdN.js";import{u as P}from"./use-message-kY66ze3r.js";function ce(){const C=B([]);function R(c){C.value=C.value.concat(c)}function p(c){const w=C.value;return(c?w.filter(n=>n.area===c):w).slice().sort((n,b)=>{const v=n.order??0,j=b.order??0;return v-j})}return{actions:C,register:R,list:p}}const fe={style:{display:"flex","flex-direction":"column",gap:"12px"}},me={style:{display:"flex","align-items":"center","justify-content":"space-between",gap:"12px"}},pe={style:{"margin-top":"12px"}},be={style:{"margin-top":"12px"}},ve={style:{margin:"0",padding:"8px",background:"rgba(0,0,0,0.04)","border-radius":"6px"}},xe=$({__name:"manual-compose-page",setup(C){const R=de(),p=G(E(89)),c=Q(),w=H(c),x=P(),n=J({adapter:p.adapter,debounceMs:150,dedupe:!0,onError(i){console.error(i)}}),b=B(!1),v=B(null),j=D(()=>v.value?"edit":"create");function K(){v.value=null,b.value=!0}function O(i){v.value=i,b.value=!0}const T=ce();function z(i){T.register(i)}z({id:"refresh",area:"toolbar",label:"刷新",order:10,onClick:async()=>{await n.refresh()}}),z({id:"reset-data",area:"toolbar",label:"重置数据",order:20,onClick:async()=>{p.reset(E(89)),await n.refresh()}}),z({id:"batch-delete",area:"batch",label:"批量删除选中",order:10,disabled:i=>i.selectedRows.length===0,onClick:async i=>{var a,d;const e=i.selectedRows.map(f=>f.id);for(const f of e)await((d=(a=p.adapter).remove)==null?void 0:d.call(a,f));await n.refresh()}});const q=$({name:"ActionBar",props:{area:{type:String,required:!0}},setup(i){const e=P(),a=M(se,null),d=M(re,null),f=M(h,D(()=>[])),S=M(ee,B(new Set)),u=D(()=>a?Array.isArray(a)?a.filter(s=>s.area===i.area).slice().sort((s,y)=>(s.order??0)-(y.order??0)):a.list(i.area):[]);function g(){var s;return{selectedRows:f.value,query:((s=d==null?void 0:d.query)==null?void 0:s.value)??{},extra:{selectedIds:Array.from(S.value)}}}function k(s){const y=g();s.visible&&!s.visible(y)||s.disabled&&s.disabled(y)||Promise.resolve(s.onClick(y)).catch(A=>{e.error(String((A==null?void 0:A.message)??A))})}return()=>u.value.length===0?null:I(F,{size:8,align:"center"},{default:()=>u.value.map(s=>I(V,{size:"small",type:s.type,disabled:s.disabled?s.disabled(g()):!1,onClick:()=>k(s)},{default:()=>s.label??s.id}))})}});async function U(i){var e,a,d,f,S;try{const{mode:u,data:g}=i,k=await te(c,g,{mode:u,trigger:"submit"});if(!k.valid){const s=Object.keys(k.errors)[0],y=s?(e=k.errors[s])==null?void 0:e[0]:"校验失败";x.error(y??"校验失败");return}if(u==="create")await((d=(a=p.adapter).create)==null?void 0:d.call(a,g));else{const s=v.value;if(!s){x.error("未选择要编辑的行");return}await((S=(f=p.adapter).update)==null?void 0:S.call(f,s.id,g))}await n.refresh(),b.value=!1,x.success("保存成功")}catch(u){x.error(String((u==null?void 0:u.message)??u))}}return ae(()=>{n.refresh()}),(i,e)=>(ie(),oe("div",fe,[r(t(ne),{type:"info",bordered:!1},{default:o(()=>[e[7]||(e[7]=l(" 这个页面不使用 ",-1)),r(t(m),{code:""},{default:o(()=>[...e[1]||(e[1]=[l("NaiveAutoCrud",-1)])]),_:1}),e[8]||(e[8]=l("，而是手动组合 ",-1)),r(t(m),{code:""},{default:o(()=>[...e[2]||(e[2]=[l("useCrud",-1)])]),_:1}),e[9]||(e[9]=l(" + ",-1)),r(t(m),{code:""},{default:o(()=>[...e[3]||(e[3]=[l("CrudProvider",-1)])]),_:1}),e[10]||(e[10]=l(" + ",-1)),r(t(m),{code:""},{default:o(()=>[...e[4]||(e[4]=[l("NaiveCrudSearch/Table/Form",-1)])]),_:1}),e[11]||(e[11]=l("，并演示 ",-1)),r(t(m),{code:""},{default:o(()=>[...e[5]||(e[5]=[l("useCrudActions",-1)])]),_:1}),e[12]||(e[12]=l(" 与 ",-1)),r(t(m),{code:""},{default:o(()=>[...e[6]||(e[6]=[l("validateFields",-1)])]),_:1}),e[13]||(e[13]=l("。 ",-1))]),_:1}),r(t(W),{crud:t(n),fields:t(c),columns:t(w),actions:t(T),user:{roles:["admin"]},extra:{from:"manual-page"},"control-map":t(L),"dict-api":t(R),"get-id":a=>a.id},{default:o(()=>[r(t(le),null,{default:o(()=>[N("section",me,[r(t(F),{size:8,align:"center"},{default:o(()=>[r(t(V),{type:"primary",onClick:K},{default:o(()=>[...e[14]||(e[14]=[l("新增",-1)])]),_:1}),r(t(q),{area:"toolbar"}),r(t(ue),{vertical:""}),r(t(q),{area:"batch"})]),_:1}),r(t(m),{depth:"3",style:{"font-size":"12px"}},{default:o(()=>[l(" 当前模式："+_(j.value)+"，列表共 "+_(t(n).total.value)+" 条 ",1)]),_:1})]),N("section",pe,[r(t(X))]),N("section",be,[r(t(Y),{columns:t(w),"show-selection":!0,"show-actions-column":!0},{"row-actions":o(({row:a})=>[r(t(F),{size:8,justify:"center"},{default:o(()=>[r(t(V),{size:"small",tertiary:"",onClick:d=>O(a)},{default:o(()=>[...e[15]||(e[15]=[l("编辑",-1)])]),_:1},8,["onClick"])]),_:2},1024)]),_:1},8,["columns"])]),r(t(Z),{modelValue:b.value,"onUpdate:modelValue":e[0]||(e[0]=a=>b.value=a),row:v.value,fields:t(c),"form-mode":"modal","reset-on-close":"",onSubmit:U},{"field-remark":o(({model:a})=>[r(t(m),{depth:"3",style:{display:"block","margin-bottom":"8px"}},{default:o(()=>[...e[16]||(e[16]=[l(" 这里是自定义 field slot（并且该字段仅当 status=disabled 时可见） ",-1)])]),_:1}),N("pre",ve,_(a.remark),1)]),_:1},8,["modelValue","row","fields"])]),_:1})]),_:1},8,["crud","fields","columns","actions","control-map","dict-api","get-id"])]))}});export{xe as default};
